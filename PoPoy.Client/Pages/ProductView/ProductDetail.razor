@page "/product-detail/{id:int}"
@inject IProductService _productSvc;
@inject ILocalStorageService LocalStorage
@inject IToastService _toastSvc;
@inject ICartService _cartSvc;
@inject IConfiguration _config;

<PageInfos Title="@product.Title"></PageInfos>
<div class="bg-main">
    <div class="container">
        <div class="box">
            <div class="breadcumb">
                <a href="./index.html">home</a>
                <span><i class="bx bxs-chevrons-right"></i></span>
                <a href="./products.html">all products</a>
                <span><i class="bx bxs-chevrons-right"></i></span>
                <a href="./product-detail.html">JBL Tune 750TNC</a>
            </div>
        </div>
        <div class="row product-row">
            <div class="col-5">
                @try
                {
                    @if (product.ProductImages.Any())
                    {
                        <div class="product-img" id="product-img">
                            <img src="@product.ProductImages.FirstOrDefault().ImagePath" alt="">
                        </div>
                        <div class="box">
                            <div class="product-img-list">
                                @foreach (var item in product.ProductImages)
                                {
                                    <div class="product-img-item">
                                        <img src="@item.ImagePath" alt="">
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <img src="@_config["BackendApiUrl"]/uploads/no-photo-available.png" alt="">
                    }
                }
                catch { }


            </div>
            <div class="col-7">
                <div class="product-info">
                    <h1>
                        @product.Title <br />
                    </h1>
                    <div class="product-info-detail">
                        <span class="product-info-detail-title">Lượt xem:</span>
                        @product.Views
                    </div>
                    <div class="product-info-detail">
                        <span class="product-info-detail-title">Danh mục: </span>
                        @try
                        {
                            if (product.ProductInCategories.Any())
                            {
                                @product.ProductInCategories.FirstOrDefault().Category.Name
                            }
                        }
                        catch { }
                    </div>
                    <div class="product-info-detail">
                        <span class="product-info-detail-title">
                            Rated:
                            @if (@product.CheckoutCount + @product.Views >= 1 && @product.CheckoutCount + @product.Views < 20)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="1" />
                            }
                            @if (@product.CheckoutCount + @product.Views >= 20 && @product.CheckoutCount + @product.Views < 30)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="2" />
                            }
                            @if (@product.CheckoutCount + @product.Views >= 30 && @product.CheckoutCount + @product.Views < 40)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="3" />
                            }
                            @if (@product.CheckoutCount + @product.Views >= 40 && @product.CheckoutCount + @product.Views < 50)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="4" />
                            }
                            @if (@product.CheckoutCount + @product.Views >= 50)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="5" />
                            }
                            @if (@product.CheckoutCount + @product.Views == 0)
                            {
                                <RadzenRating ReadOnly="true" Stars="5" Value="0" />
                            }
                        </span>
                    </div>
                    <p class="product-description">
                        @product.Description
                    </p>
                    <div class="product-info-price">@product.Price.ToString("n0")</div>

                    <SelectQuantity Model="@cart" CartUpdateType="CartUpdateType.Add" />
                    <SelectSize Model="@cart" CartUpdateType="CartUpdateType.Add" Product_Id="@id"></SelectSize>
                    <br />
                    <span style="font-size:15px">Số lượng còn lại: </span><span style="color:red;font-size:15px">@product.Stock</span>
                    <div>
                        <button class="btn-flat btn-hover" @onclick="AddToCart">add to cart</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="box">
            <div class="box-header">
                description
            </div>
            <div class="product-detail-description">
                <button class="btn-flat btn-hover btn-view-description" id="view-all-description">
                    view all
                </button>
                <div class="product-detail-description-content">
                    <p>
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Impedit laudantium obcaecati odit dolorem, doloremque accusamus esse neque ipsa dignissimos saepe quisquam tempore perferendis deserunt sapiente! Recusandae illum totam earum ratione.
                        Lorem ipsum dolor sit, amet consectetur adipisicing elit. Aliquam incidunt maxime rerum reprehenderit voluptas asperiores ipsam quas consequuntur maiores, at odit obcaecati vero sunt! Reiciendis aperiam perferendis consequuntur odio quas. Lorem ipsum dolor sit amet consectetur adipisicing elit. Ut quaerat eum veniam doloremque nihil repudiandae odio ratione culpa libero tempora. Expedita, quo molestias. Minus illo quis dignissimos aliquid sapiente error!
                    </p>
                    <img src="./images/JBL_Quantum_400_Product Image_Hero 02.png" alt="">
                    <p>
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Nobis accusantium officia, quae fuga in exercitationem aliquam labore ex doloribus repellendus beatae facilis ipsam. Veritatis vero obcaecati iste atque aspernatur ducimus.
                        Lorem ipsum dolor sit, amet consectetur adipisicing elit. Repellat quam praesentium id sit amet magnam ad, dolorum, cumque iste optio itaque expedita eius similique, ab adipisci dicta. Quod, quibusdam quas. Lorem ipsum dolor sit amet consectetur adipisicing elit. Odit, in corrupti ipsam sint error possimus commodi incidunt suscipit sit voluptatum quibusdam enim eligendi animi deserunt recusandae earum natus voluptas blanditiis?
                    </p>
                    <img src="./images/kisspng-beats-electronics-headphones-apple-beats-studio-red-headphones.png" alt="">
                    <p>
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Modi ullam quam fugit veniam ipsum recusandae incidunt, ex ratione, magnam labore ad tenetur officia! In, totam. Molestias sapiente deserunt animi porro?
                    </p>
                </div>
            </div>
        </div>
        <div class="box">
            <div class="box-header">
                review
            </div>
            <div>
                <div class="user-rate">
                    <div class="user-info">
                        <div class="user-avt">
                            <img src="./images/tuat.jpg" alt="">
                        </div>
                        <div class="user-name">
                            <span class="name">tuat tran anh</span>
                            <span class="rating">
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                            </span>
                        </div>
                    </div>
                    <div class="user-rate-content">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Distinctio ea iste, veritatis nobis amet illum, cum alias magni dolores odio, eius quo excepturi veniam ipsa voluptatibus natus voluptas vero? Aspernatur!
                    </div>
                </div>
                <div class="user-rate">
                    <div class="user-info">
                        <div class="user-avt">
                            <img src="./images/tuat.jpg" alt="">
                        </div>
                        <div class="user-name">
                            <span class="name">tuat tran anh</span>
                            <span class="rating">
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                            </span>
                        </div>
                    </div>
                    <div class="user-rate-content">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Distinctio ea iste, veritatis nobis amet illum, cum alias magni dolores odio, eius quo excepturi veniam ipsa voluptatibus natus voluptas vero? Aspernatur!
                    </div>
                </div>
                <div class="user-rate">
                    <div class="user-info">
                        <div class="user-avt">
                            <img src="./images/tuat.jpg" alt="">
                        </div>
                        <div class="user-name">
                            <span class="name">tuat tran anh</span>
                            <span class="rating">
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                            </span>
                        </div>
                    </div>
                    <div class="user-rate-content">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Distinctio ea iste, veritatis nobis amet illum, cum alias magni dolores odio, eius quo excepturi veniam ipsa voluptatibus natus voluptas vero? Aspernatur!
                    </div>
                </div>
                <div class="user-rate">
                    <div class="user-info">
                        <div class="user-avt">
                            <img src="./images/tuat.jpg" alt="">
                        </div>
                        <div class="user-name">
                            <span class="name">tuat tran anh</span>
                            <span class="rating">
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                            </span>
                        </div>
                    </div>
                    <div class="user-rate-content">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Distinctio ea iste, veritatis nobis amet illum, cum alias magni dolores odio, eius quo excepturi veniam ipsa voluptatibus natus voluptas vero? Aspernatur!
                    </div>
                </div>
                <div class="user-rate">
                    <div class="user-info">
                        <div class="user-avt">
                            <img src="./images/tuat.jpg" alt="">
                        </div>
                        <div class="user-name">
                            <span class="name">tuat tran anh</span>
                            <span class="rating">
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                                <i class="bx bxs-star"></i>
                            </span>
                        </div>
                    </div>
                    <div class="user-rate-content">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Distinctio ea iste, veritatis nobis amet illum, cum alias magni dolores odio, eius quo excepturi veniam ipsa voluptatibus natus voluptas vero? Aspernatur!
                    </div>
                </div>
                <div class="box">
                    <ul class="pagination">
                        <li><a href="#"><i class="bx bxs-chevron-left"></i></a></li>
                        <li><a href="#" class="active">1</a></li>
                        <li><a href="#">2</a></li>
                        <li><a href="#">3</a></li>
                        <li><a href="#">4</a></li>
                        <li><a href="#">5</a></li>
                        <li><a href="#"><i class="bx bxs-chevron-right"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
        <ProductList></ProductList>
        <Pagination MetaData="MetaData" Spread="2" SelectedPage="SelectedPage" />
    </div>
</div>
@code {
    [Parameter]
    public int id { get; set; }
    private Cart cart;
    private Product product;
    private List<ProductSize> List_Size{ get; set; }=new List<ProductSize>();
    public MetaData MetaData { get; set; } = new MetaData();
    private ProductParameters _productParameters = new ProductParameters();
    protected override async Task OnParametersSetAsync()
    {
        product = new Product();
        var result = await _productSvc.Get(id);
        if (result.Success)
        {
            product = result.Data;
        }
        cart = new Cart() { Quantity = 1, Product = product};
    }

    private async Task SelectedPage(int page)
    {
        _productParameters.PageNumber = page;
        await GetProducts();
    }
    private async Task GetProducts()
    {
        await _productSvc.GetAll(_productParameters, product.ProductInCategories.FirstOrDefault().Category.Url);
        MetaData = _productSvc.Products.MetaData;
    }
    private async void AddToCart()
    {
        if (cart.SizeId <= 0)
        {
            _toastSvc.ShowError("Mời chọn size!");
            StateHasChanged();
        }
        if (cart.Quantity > product.Stock)
        {
            _toastSvc.ShowError("Số lượng không đủ. Mời đặt lại!");
            StateHasChanged();
        }
        if (product.Stock <= 0)
        {
            _toastSvc.ShowError("Mặt hàng này đã hết. Mời quý khách vui lòng chọn món hàng khác!");
            StateHasChanged();
        }
        if(cart.SizeId > 0 && cart.Quantity <= product.Stock && product.Stock > 0)
        {
            await _cartSvc.AddAsync(cart.ToCartStorage());
            _toastSvc.ShowSuccess($"Thêm thành công {cart.Product.Title} x{cart.Quantity}");
        }
    }
}
