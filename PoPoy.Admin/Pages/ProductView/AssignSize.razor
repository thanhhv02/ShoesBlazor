@page "/sizesd/{Id}"

@inject IProductService ProductService
@inject NavigationManager NavigationManager

<div class="card-body">
    <EditForm Model="Model" OnValidSubmit="AssignSizes">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Chọn kích cở</RadzenText>
            <RadzenListBox Multiple AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" FilterOperator="StringFilterOperator.Contains" @bind-Value=@listSize
                           Data=@Model.Sizes TextProperty="Name" ValueProperty="Id" Change=@(args => OnChangeSize(args)) Style="height:200px" Class="w-100">
            </RadzenListBox>

        </RadzenCard>
        <RadzenCard>
            <hr>
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Nhập số lượng</RadzenText>
            @if (Model != null)
            {
                <div class="row mt-4">
                    @foreach (var item in Model.Sizes.Where(p => p.Selected == true).ToList())
                    {
                        <div class="text-field col-3 mb-4 mr-1">
                            <label style="font-size:17px;">Size @item.Name</label>
                            <input type="number" min="0" @bind-value="@item.Qty" />
                        </div>
                    }
                </div>

            }

            <div class="row mt-3">
                <div class="col-md-12 text-end">
                    <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Icon="add_circle" Text="Lưu lại" Style="width: 120px" />
                </div>
            </div>
        </RadzenCard>
    </EditForm>
</div>

@code{
    [Parameter]
    public string Id { get; set; }
    public SizeAssignRequest Model = new SizeAssignRequest();
    List<string> listSize = new List<string>();
    [Inject] private IToastService toastService { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Model = await ProductService.GetSizeAssignRequest(int.Parse(Id));
        Model.Id = int.Parse(Id);
        Model.Sizes.ForEach(p =>
        {
            if (p.Selected) listSize.Add(p.Id);
        });
    }

    void OnChangeSize(object value)
    {
        if (listSize != null)
        {

            Model.Sizes.ForEach(p => { if (listSize.Any(C => C == p.Id)) p.Selected = true; else p.Selected = false; });

        }

        StateHasChanged();
    }

    private async Task AssignSizes()
    {
        await ProductService.AssignSize(Model);
        toastService.ShowSuccess("Cập nhật kích thước thành công");

        StateHasChanged();
    }
}

