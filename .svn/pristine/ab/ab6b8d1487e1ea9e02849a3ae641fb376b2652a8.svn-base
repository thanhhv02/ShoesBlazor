@inject Microsoft.Extensions.Configuration.IConfiguration config;
@using System.Net;
@inject IToastService _toastSvc;
@inject AuthenticationStateProvider auth
@inject NavigationManager NavigationManager
@using PoPoy.Shared.ViewModels
@inject IAuthService AuthService;
@attribute [Authorize]

<div class="col-lg-6">
    <div class="information_module">
        <a class="toggle_title" href="#changepass-collapse" data-toggle="collapse">
            <h4>
                Đổi mật khẩu
                <span class="fa-solid fa-chevron-down"></span>
            </h4>
        </a>
        <EditForm Model="model" OnValidSubmit="HandelSubmit">
            <div class="information__set toggle_module collapse show" id="changepass-collapse">
                <div class="information_wrapper form--fields">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="form-group">
                        <label>Mật khẩu cũ <sup>*</sup></label>
                        <InputText id="oldpass-txt" type="password" @bind-Value="model.CurrentPassword" class="text_field" placeholder="Nhập vào mật khẩu cũ của bạn" required="">
                        </InputText>
                        <ValidationMessage For="()=>model.CurrentPassword"></ValidationMessage>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Mật khẩu mới <sup>*</sup></label>
                                <InputText id="newpass-txt" type="password" @bind-Value="model.NewPassword" class="text_field" placeholder="Mật khẩu mới" required="">
                                </InputText>
                                <ValidationMessage For="()=>model.NewPassword"></ValidationMessage>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nhập lại mật khẩu <sup>*</sup></label>
                                <InputText id="repass-txt" @bind-Value="model.ConfirmPassword" type="password" class="text_field" placeholder="Nhập lại mật khẩu" required="">
                                </InputText>
                                <ValidationMessage For="()=>model.ConfirmPassword"></ValidationMessage>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom:0; text-align:right">
                        <button class="btn btn--xs" type="submit">Lưu</button>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>

</div>

@code {
    private ChangePasswordRequest model { get; set; } = new ChangePasswordRequest();
    [CascadingParameter] protected Task<AuthenticationState> AuthStat { get; set; }
    protected async override Task OnInitializedAsync()
    {
        var user = (await AuthStat).User;

        if (!user.Identity.IsAuthenticated)
        {
            _toastSvc.ShowInfo("Bạn chưa đăng nhập !");
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/");
        }
    }
    public async void HandelSubmit()
    {

        var user = (await AuthStat).User;
        ChangePasswordRequest ChangePasswordView = new ChangePasswordRequest()
        {
            UserId = user.GetUserId(),
            CurrentPassword = model.CurrentPassword,
            NewPassword = model.NewPassword,
            ConfirmPassword = model.ConfirmPassword
        };

        var result = await AuthService.ChangePassword(ChangePasswordView);

        if (result.Success)
        {

            _toastSvc.ShowSuccess($"Đổi mật khẩu thành công. Vui lòng đăng nhập lại");
            await AuthService.Logout();
        }
        else
        {

            _toastSvc.ShowError(result.Message);

        }

    }
}
